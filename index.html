<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Virtual Interview</title>
    <style>
        #question-container {
            display: none;
        }
        #countdown {
            font-size: 24px;
            color: red;
        }
    </style>
</head>
<body>
    <div id="interview-container">
        <p id="instructions">The interview will be conducted in English. You will have 10 seconds to answer each question. Your mic and camera will be turned on during the interview. If any of these devices are faulty or not working, you will be informed.</p>
        <button id="start-interview-button">Start Interview</button>
        <button id="check-devices-button">Check Devices</button>
    </div>
    <div id="question-container">
        <p id="progress"></p>
        <p id="question"></p>
        <video id="video" width="640" height="480" autoplay></video>
        <p id="countdown"></p>
        <button id="submit-button" style="display:none;">Submit Interview</button>
    </div>
    <p id="status" style="color:red;"></p>

    <script>
        document.getElementById('check-devices-button').onclick = async function() {
            const statusElem = document.getElementById('status');
            statusElem.textContent = 'Checking devices...';

            try {
                const response = await fetch('/check-devices', { method: 'POST' });
                if (response.ok) {
                    const result = await response.json();
                    if (result.status === 'success') {
                        statusElem.textContent = "All devices are working.";
                    } else {
                        if (!result.mic) statusElem.textContent = "Microphone is not working. Please fix it or try another device.";
                        if (!result.camera) statusElem.textContent = "Camera is not working. Please fix it or try another device.";
                    }
                } else {
                    statusElem.textContent = "An error occurred while checking devices.";
                }
            } catch (error) {
                console.error('Error checking devices:', error);
                statusElem.textContent = "An error occurred while checking devices.";
            }
        };

        document.getElementById('start-interview-button').onclick = async function() {
            try {
                await navigator.mediaDevices.getUserMedia({ video: true, audio: true });

                const response = await fetch('/conduct-interview', { method: 'POST' });
                const result = await response.json();
                const questions = result.questions;

                document.getElementById('interview-container').style.display = 'none';
                document.getElementById('question-container').style.display = 'block';

                let questionIndex = 0;

                function askNextQuestion() {
                    if (questionIndex < questions.length) {
                        document.getElementById('question').textContent = questions[questionIndex];
                        document.getElementById('progress').textContent = `Question ${questionIndex + 1} of ${questions.length}`;
                        recordAnswer(questionIndex, () => {
                            questionIndex++;
                            if (questionIndex < questions.length) {
                                askNextQuestion();
                            } else {
                                endInterview();
                            }
                        });
                    } else {
                        endInterview();
                    }
                }

                askNextQuestion();
            } catch (error) {
                console.error('Error starting interview:', error);
                document.getElementById('status').textContent = "An error occurred while starting the interview.";
            }
        }

        function startCountdown(seconds, callback) {
            const countdownElem = document.getElementById('countdown');
            let remainingTime = seconds;
            countdownElem.textContent = `Time left: ${remainingTime}s`;
            const interval = setInterval(() => {
                remainingTime--;
                countdownElem.textContent = `Time left: ${remainingTime}s`;
                if (remainingTime <= 0) {
                    clearInterval(interval);
                    callback();
                }
            }, 1000);
        }

        function recordAnswer(index, callback) {
            const videoElem = document.getElementById('video');
            navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(stream => {
                videoElem.srcObject = stream;
                const mediaRecorder = new MediaRecorder(stream);
                const chunks = [];

                mediaRecorder.ondataavailable = function(event) {
                    chunks.push(event.data);
                };

                mediaRecorder.onstop = function() {
                    const blob = new Blob(chunks, { 'type': 'video/mp4;' });
                    const formData = new FormData();
                    formData.append('video', blob, `question_${index}.mp4`);

                    fetch('/save-video', { method: 'POST', body: formData });
                };

                // Start recording
                mediaRecorder.start();

                // Start countdown for 45 seconds
                startCountdown(45, () => {
                    // Stop the recording after the countdown completes
                    if (mediaRecorder.state !== 'inactive') {
                        mediaRecorder.stop();
                        stream.getTracks().forEach(track => track.stop());
                        // Wait for an additional 10 seconds before proceeding
                        setTimeout(callback, 10000);
                    }
                });
            }).catch(error => {
                console.error('Error accessing media devices:', error);
                document.getElementById('status').textContent = "An error occurred while accessing media devices.";
            });
        }

        function endInterview() {
            document.getElementById('question-container').innerHTML = "<p>You will be contacted by the HR team if selected for this internship. You can now submit your interview recordings.</p>";
            document.getElementById('submit-button').style.display = 'block';

            document.getElementById('submit-button').onclick = async function() {
                const videoElem = document.getElementById('video');
                const stream = videoElem.srcObject;
                if (stream) {
                    const tracks = stream.getTracks();
                    tracks.forEach(track => track.stop()); // Stop all tracks
                }

                // Handle any additional final submission logic here
                alert('Interview submitted. Thank you!');
                window.location.reload(); // Reload the page to restart the interview process
            };
        }
    </script>
</body>
</html>